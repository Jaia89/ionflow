<!--
wl-10-08-2020, Mon: commence
wl-24-08-2020, Mon: first version
-->

<tool id="ionfow" name="IonFlow" version="0.1.0">
  <description>
    Pipeline for processing and analysis of ionomics data
  </description>
  <macros>
    <import>macros.xml</import>
  </macros>
  <expand macro="requirements" />
  <expand macro="stdio" />

  <!-- =============================================================== -->
  <command detect_errors="exit_code">
    <![CDATA[

      Rscript ${__tool_directory__}/ionflow.R
        --ion_file '$ion_file'

        ## use std file or not
        --std_file_sel '$std.std_file_sel'
        #if $std.std_file_sel=='yes':
          --std_file '$std.std_file'
        #end if

        ## Clustering and network analysis
        --thres_clus '$thres_clus'
        --thres_anno '$thres_anno'
        --thres_corr '$thres_corr'

        ## output: pre-processing
        --pre_proc_pdf  '$pre_proc_pdf'
        --df_stats_out  '$df_stats_out'
        --outl_out  '$outl_out'
        --data_wide_out  '$data_wide_out'
        --data_wide_symb_out  '$data_wide_symb_out'

        ## output: exploratory analysis
        --exp_anal_pdf  '$exp_anal_pdf'

        ## output: gene clustering
        --gene_clus_pdf  '$gene_clus_pdf'
        --clus_out  '$clus_out'
        --anno_out  '$anno_out'
        --enri_out  '$enri_out'

        ## output: gene network
        --gene_net_pdf  '$gene_net_pdf'
        --imbe_out  '$imbe_out'
        --imbe_tab_out  '$imbe_tab_out'
    ]]>
  </command>

  <!-- =============================================================== -->
  <inputs>
    <param name="ion_file" type="data"  format="tabular"
           label="Ion data table"
           help="Ion data table with columns of Ions and rows of knockout. 
                 The first two columns must be names of knowckout and batch ID." />

    <conditional name="std">
      <param name="std_file_sel" type="select"
             label="Use user defined ion std file or not" 
             help="Use manul std values or calculation from ion data for 
                   standardisation.">
        <option value="yes" selected="true">Use defined file</option>
        <option value="no">Caculate from data set</option>
      </param>

      <when value="yes">
        <param name="std_file" type="data"  format="tabular" 
               label="STD file" 
               help="A data matrix containing only two columns. The fisrt 
                     column is the names of ion and the second one is std i
                     values. " />
      </when>
      <when value="no">
      </when>
    </conditional>

    <param name="thres_clus" type="float" value="10" 
            label="Specify clustering threshold"
            help="Gene number threshold in a hierarchical clustering centre." /> 

    <param name="thres_anno" type="float" value="5.0" min="0" max="100"
           label="Specify annotation percentage threshold"
           help="Percentage threshold for annotation (0 - 100).
                 Features large than threshold will be kept." />

    <param name="thres_corr" type="float" value="0.60" min="0" max="1"
           label="Specify correlation threshold"
           help="Correlation threshold for network analysis (0 - 1).  
                 Features large than threshold will be kept." /> 

  </inputs>


  <!-- =============================================================== -->
  <outputs>
    <data format="pdf" name="pre_proc_pdf" 
          label="Pre-processing plots for Ions on ${on_string}" />
    <data format="tabular" name="df_stats_out" 
          label="Statistical summary of data set on ${on_string}"/>
    <data format="tabular" name="outl_out" 
          label="Outlier table on ${on_string}"/>
    <data format="tabular" name="data_wide_out" 
          label="Pre-processed data in wide format on ${on_string}"/>
    <data format="tabular" name="data_wide_symb_out" 
          label="Symbolization data in wide format on ${on_string}"/>

    <data format="pdf" name="exp_anal_pdf" 
          label="Explanatation analysis plots for Ions on ${on_string}" />

    <data format="pdf" name="gene_clus_pdf" 
          label="Gene clustering plots on ${on_string}" />
    <data format="tabular" name="clus_out" 
          label="Clustering table on ${on_string}"/>
    <data format="tabular" name="anno_out" 
          label="Annotation table on ${on_string}"/>
    <data format="tabular" name="enri_out" 
          label="Enrichment table on ${on_string}"/>

    <data format="pdf" name="gene_net_pdf" 
          label="Gene network plots on ${on_string}" />
    <data format="tabular" name="imbe_out" 
          label="Impact and betweenness table on ${on_string}"/>
    <data format="tabular" name="imbe_tab_out" 
          label="Impact and betweenness contingency table on ${on_string}"/>

  </outputs>

  <!-- =============================================================== -->
  <tests>
    <!-- test on smaller data set -->
    <test>
      <param name="ion_file" value="iondata_test.tsv" />
      <param name="std_file_sel" value="yes" />
      <param name="std_file" value="user_std.tsv" />
      <param name="thres_clus" value="5.0" />
      <param name="thres_anno" value="10.0" />
      <param name="thres_corr" value="0.75" />
      <output name="pre_proc_pdf" file="res/pre_proc.pdf" compare="sim_size" />
      <output name="df_stats_out" file="res/df_stats.tsv" compare="diff" />
      <output name="outl_out" file="res/outl.tsv" compare="diff" />
      <output name="data_wide_out" file="res/data_wide.tsv" compare="diff" />
      <output name="data_wide_symb_out" file="res/data_wide_symb.tsv" compare="diff" />
      <output name="exp_anal_pdf" file="res/exp_anal.pdf" compare="sim_size" />
      <output name="gene_clus_pdf" file="res/gene_clus.pdf" compare="sim_size" />
      <output name="clus_out" file="res/clus.tsv" compare="diff" />
      <output name="anno_out" file="res/kegg_go_anno.tsv" compare="diff" />
      <output name="enri_out" file="res/go_enri.tsv" compare="diff" />
      <output name="gene_net_pdf" file="res/gene_net.pdf" compare="sim_size" />
      <output name="imbe_out" file="res/impact_betweenness.tsv" compare="diff" />
      <output name="imbe_tab_out" file="res/impact_betweenness_tab.tsv" />
    </test>

    <!-- test on full data set -->
    <test>
      <param name="ion_file" value="iondata.tsv" />
      <param name="std_file_sel" value="yes" />
      <param name="std_file" value="user_std.tsv" />
      <param name="thres_clus" value="10.0" />
      <param name="thres_anno" value="5.0" />
      <param name="thres_corr" value="0.6" />
      <output name="pre_proc_pdf" file="res/pre_proc_1.pdf" compare="sim_size" />
      <output name="df_stats_out" file="res/df_stats_1.tsv" />
      <output name="outl_out" file="res/outl_1.tsv" />
      <output name="data_wide_out" file="res/data_wide_1.tsv" />
      <output name="data_wide_symb_out" file="res/data_wide_symb_1.tsv" />
      <output name="exp_anal_pdf" file="res/exp_anal_1.pdf" compare="sim_size" />
      <output name="gene_clus_pdf" file="res/gene_clus_1.pdf" compare="sim_size" />
      <output name="clus_out" file="res/clus_1.tsv" />
      <output name="anno_out" file="res/kegg_go_anno_1.tsv" />
      <output name="enri_out" file="res/go_enri_1.tsv" />
      <output name="gene_net_pdf" file="res/gene_net_1.pdf" compare="sim_size" />
      <output name="imbe_out" file="res/impact_betweenness_1.tsv" />
      <output name="imbe_tab_out" file="res/impact_betweenness_tab_1.tsv" />
    </test>

  </tests>

  <!-- =============================================================== -->
<help>
IonFlow  Pipeline
=================

Description
-----------

This galaxy tool wraps R package IonFlow_ to process ionomics data to
aid reproducible data sharing and big data initiatives.

The pipeline includes:

Pre-processing
  This procedure uses quantile (boxplot) method to perform outlier
  detection, median shift for batch correction, standard derivation of each
  ion for standardisation after logarithm transformation.  The processed
  concentration data and a symbolization profile data are returned for
  further analysis.

Exploratory analysis
  It includes PCA analysis, hierarchical clustering for both ion and
  knockout, and correlation analysis with heatmap and network analysis.

Gene Clustering
  This stage uses hierarchical clustering based on symbolised profile. The
  genes located in the clustering centre with number large than a threshold
  are then used for the GO Slim annotation and the GO terms enrichment
  analysis.

Gene Network
  This part uses hierarchical clustering based on the symbolised profile to
  select genes located in the clustering centre with number large than a
  threshold for correlation analysis. Genes with correlation coefficient
  large than a threshold are then used for network analysis. Some network
  analysis stats such as impact and betweenness are also returned.


.. _IonFlow: https://github.com/AlinaPeluso/MetaboFlow

Inputs
------

**\1. Ionomics data**

The input file is an ionomics data table in tubular format. The following is
an example with the first two columns of knockout name and batch ID and
other columns are ions.


 +----------+----------+---------+-------+-------+--------+----------+---------+-------+---------+-------+----------+----------+
 | Knockout | Batch_ID | Ca      | Cd    | Cu    | Fe     | K        | Mg      | Mo    | Na      | Ni    | P        | S        |
 +----------+----------+---------+-------+-------+--------+----------+---------+-------+---------+-------+----------+----------+
 | YDL227C  | 14       | 59.549  | 0.953 | 2.202 | 10.942 | 3448.070 | 693.992 | 1.603 | 259.816 | 1.573 | 4963.315 | 556.397  |
 +----------+--+-------+---------+-------+-------+--------+----------+---------+-------+---------+-------+----------+----------+
 | YDL227C  | 14       | 62.258  | 0.927 | 2.067 | 26.262 | 3493.741 | 705.008 | 2.691 | 273.640 | 4.443 | 4874.101 | 553.229  |
 +----------+--+-------+---------+-------+-------+--------+----------+---------+-------+---------+-------+----------+----------+
 | YDL227C  | 14       | 65.075  | 0.875 | 2.048 | 10.244 | 3317.611 | 691.411 | 1.878 | 278.167 | 1.448 | 4608.300 | 535.609  |
 +----------+--+-------+---------+-------+-------+--------+----------+---------+-------+---------+-------+----------+----------+
 | YDL227C  | 14       | 56.886  | 0.985 | 2.203 |  9.206 | 3330.854 | 702.734 | 1.396 | 268.609 | 1.640 | 5119.736 | 546.230  |
 +----------+----------+---------+-------+-------+--------+----------+---------+-------+---------+-------+----------+----------+

|

**\2. STD values**

Standard derivation values can be provide by user or calculated from ion
data set. These values are used to standardize ion data. The user defined
std file has tabular format such as:

  +------+----------+
  |  Ion |   sd     |
  +------+----------+
  |  Ca  | 0.150    |
  +------+----------+
  |  Fe  | 0.163    |
  +------+----------+
  |  K   | 0.094    |
  +------+----------+
  |  Mg  | 0.059    |
  +------+----------+
  |  Na  | 0.107    |
  +------+----------+
  |  Ni  | 0.078    |
  +------+----------+
  |  Zn  | 0.067    |
  +------+----------+

|

Parameters
----------

**\1. Threshold for cluster**

The threshold is for the gene number in a cluster centre with the default
value of 10. Genes located in a cluster center with gene number large than
the threshold will be used for further analysis, such as annotation and
network analysis.

**\2. Threshold for annotation**

The threshold is for the percentage of the genes in a cluster centre used
for annotation. The default is 5 percent. Genes with percentage large than
threshold will be annotated.

**\3. Threshold for correlation**

The threshold is the correlation coefficient cut-off for correlation network
analysis. Only those large than the threshold will be used in the network
analysis. The default is 0.6 in the range of 0 and 1.


Outputs
----------

**\1. Pre-processing**

The output includes:

- A PDF file for the plots:  dot-plot with ion vs batch and distribution
  plot of ions.
- A tabular file for statistical summary of data set
- A tabular file for outlier table
- A tabular file for processed data set
- A tabular file for the symbolisation data set

**\2. Exploratory analysis**

A single PDF file is output with plots:

- correlation map
- heatmap with dendrogram,
- correlation heatmap with dendrogram 
- correlation network graph
- PCA plot

**\3. Gene Clustering**

PDF and tubular files include:

- A PDF file for gene clustering in separate cluster centre
- A tabular for clustering table
- A tabular file for annotation table
- A tabular file for enrichment table

**\4. Gene Network**

Three files are returned:

- A PDF file for plots: network graph and impact scatter plot
- A tabular file for impact and betweenness table
- A tabular file for impact and betweenness contingency table

</help>
  <citations>
  </citations>
</tool>
